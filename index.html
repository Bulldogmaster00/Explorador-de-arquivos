<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Explorer APK Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .active-tap:active { transform: scale(0.95); opacity: 0.8; }
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 12px;
        }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 px-4 py-3 flex items-center justify-between shadow-sm shrink-0">
        <div class="flex items-center gap-2">
            <div class="bg-indigo-600 p-2 rounded-lg text-white">
                <i data-lucide="folder-up" class="w-5 h-5"></i>
            </div>
            <h1 class="font-bold text-slate-800 text-sm">Meus Ficheiros</h1>
        </div>
        
        <!-- O segredo está aqui: removi o webkitdirectory e deixei apenas multiple -->
        <label class="bg-indigo-600 text-white p-2.5 rounded-full shadow-md active-tap cursor-pointer">
            <i data-lucide="plus" class="w-6 h-6"></i>
            <input type="file" id="fileInput" multiple class="hidden">
        </label>
    </header>

    <!-- Info bar -->
    <div id="status-bar" class="bg-indigo-50 px-4 py-2 text-[10px] text-indigo-700 font-bold uppercase tracking-wider hidden">
        <span id="count-text">0 ficheiros carregados</span>
    </div>

    <!-- Lista -->
    <main class="flex-1 overflow-y-auto p-4">
        <div id="grid" class="file-grid">
            <div id="empty-state" class="col-span-full py-20 text-center text-slate-400">
                <i data-lucide="upload-cloud" class="w-12 h-12 mx-auto mb-3 opacity-20"></i>
                <p class="text-xs">Toca no + para selecionar ficheiros<br>(Podes marcar vários de uma vez)</p>
            </div>
        </div>
    </main>

    <!-- Visualizador de Imagem -->
    <div id="img-viewer" class="fixed inset-0 bg-black/95 z-50 hidden flex flex-col">
        <div class="p-4 flex justify-end">
            <button onclick="closeImg()" class="text-white p-2 bg-white/10 rounded-full"><i data-lucide="x"></i></button>
        </div>
        <div class="flex-1 flex items-center justify-center p-4">
            <img id="display-img" class="max-w-full max-h-full object-contain">
        </div>
    </div>

    <!-- Editor -->
    <div id="editor" class="fixed inset-0 bg-white z-50 hidden flex flex-col">
        <div class="p-4 border-b flex justify-between items-center bg-slate-50">
            <button onclick="closeEditor()" class="p-2"><i data-lucide="arrow-left"></i></button>
            <span id="edit-title" class="text-xs font-bold truncate px-4">Arquivo.txt</span>
            <button id="save-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold">SALVAR</button>
        </div>
        <textarea id="edit-content" class="flex-1 p-4 text-sm font-mono outline-none bg-white"></textarea>
    </div>

    <script>
        let filesMap = [];

        lucide.createIcons();

        const input = document.getElementById('fileInput');
        const grid = document.getElementById('grid');
        const statusBar = document.getElementById('status-bar');
        const countText = document.getElementById('count-text');

        input.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if(files.length === 0) return;

            // No APK, adicionamos à lista atual em vez de substituir
            filesMap = [...filesMap, ...files];
            
            document.getElementById('empty-state').classList.add('hidden');
            statusBar.classList.remove('hidden');
            countText.innerText = `${filesMap.length} ficheiros na lista`;
            
            render();
        });

        function render() {
            grid.innerHTML = '';
            filesMap.forEach((file, index) => {
                const ext = file.name.split('.').pop().toLowerCase();
                const card = document.createElement('div');
                card.className = "flex flex-col items-center p-2 rounded-xl active-tap bg-white shadow-sm border border-slate-100";
                
                let icon = 'file';
                let color = 'text-slate-400';

                if(['jpg','png','jpeg','gif'].includes(ext)) { icon = 'image'; color = 'text-blue-500'; }
                else if(['txt','md','html','js','css'].includes(ext)) { icon = 'file-text'; color = 'text-emerald-500'; }
                else if(['mp4','mov'].includes(ext)) { icon = 'video'; color = 'text-purple-500'; }

                card.innerHTML = `
                    <div class="mb-1"><i data-lucide="${icon}" class="w-8 h-8 ${color}"></i></div>
                    <span class="text-[9px] font-medium text-slate-600 truncate w-full text-center">${file.name}</span>
                `;

                card.onclick = () => openFile(file);
                grid.appendChild(card);
            });
            lucide.createIcons();
        }

        function openFile(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            const reader = new FileReader();

            if(['jpg','png','jpeg','gif'].includes(ext)) {
                reader.onload = (e) => {
                    document.getElementById('display-img').src = e.target.result;
                    document.getElementById('img-viewer').classList.remove('hidden');
                    lucide.createIcons();
                };
                reader.readAsDataURL(file);
            } 
            else if(['txt','md','html','js','css','json'].includes(ext)) {
                reader.onload = (e) => {
                    document.getElementById('edit-title').innerText = file.name;
                    document.getElementById('edit-content').value = e.target.result;
                    document.getElementById('editor').classList.remove('hidden');
                    lucide.createIcons();
                };
                reader.readAsText(file);
            }
        }

        function closeImg() { document.getElementById('img-viewer').classList.add('hidden'); }
        function closeEditor() { document.getElementById('editor').classList.add('hidden'); }

        document.getElementById('save-btn').onclick = () => {
            const content = document.getElementById('edit-content').value;
            const blob = new Blob([content], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = document.getElementById('edit-title').innerText;
            a.click();
            alert("Cópia guardada nas transferências (downloads)");
        };
    </script>
</body>
</html>

